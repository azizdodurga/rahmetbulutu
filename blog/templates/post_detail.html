{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.seo_title|default:post.title }} | CloudBlog{% endblock %}

{% block description %}{{ post.seo_description|slice:":160" }}{% endblock %}

{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.seo_description }}{% endblock %}

{% block og_image %}
{% if post.image %}
<meta property="og:image" content="{{ request.build_absolute_uri }}{{ post.image.url }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <h1 class="display-4 fw-bold mb-3">{{ post.title }}</h1>

    <!--<p class="text-muted border-bottom pb-3">
      <strong>Yazar:</strong> {{ post.author }} |
      <strong>Yayınlanma:</strong> {{ post.created_on|date:"d F Y" }}
    </p>-->

    <div class="post-content mt-4 leading-relaxed" style="font-size: 1.1rem; line-height: 1.8;">
      {{ post.content|safe }}
    </div>

{% if post.youtube_video_id %}
<div class="my-4 shadow-sm rounded-3 overflow-hidden">
  <div class="ratio ratio-16x9 bg-dark">
    <div id="youtube-player"></div>
  </div>
</div>

<script>
  // 1. Global değişkenleri tanımla (Tracker kullanabilsin diye)
  window.VIDEO_SETTINGS = {
    videoId: "{{ post.youtube_video_id }}",
    startSeconds: Math.floor(parseFloat("{{ user_progress.last_position|default:0 }}".toString().replace(',', '.')) || 0),
    csrfToken: "{{ csrf_token }}",
    saveUrl: "{% url 'save_video_progress' %}",
    origin: 'https://rahmetbulutu.onrender.com'
  };

  var player;

  // 2. Oynatıcıyı kuran ana fonksiyon
  function setupYoutubePlayer() {
    // Eğer div yoksa veya API hazır değilse çık
    if (!document.getElementById('youtube-player') || typeof YT === 'undefined' || !YT.loaded) return;

    player = new YT.Player('youtube-player', {
      height: '100%',
      width: '100%',
      videoId: window.VIDEO_SETTINGS.videoId,
      host: 'https://www.youtube.com',
      playerVars: {
        'start': window.VIDEO_SETTINGS.startSeconds,
        'playsinline': 1,
        'enablejsapi': 1,
        'origin': window.VIDEO_SETTINGS.origin,
        'widget_referrer': window.VIDEO_SETTINGS.origin
      },
      events: {
        'onStateChange': function(event) {
            // video_tracker.js içindeki fonksiyonu tetikle
            if (typeof onPlayerStateChange === 'function') {
                onPlayerStateChange(event);
            }
        },
        'onError': function(e) { 
            console.log("YouTube Error:", e.data);
            if(e.data == 153 || e.data == 101) {
                document.getElementById('youtube-player').innerHTML = '<div class="text-white p-4 text-center">Video bu tarayıcıda kısıtlı. <a href="https://youtube.com/watch?v='+window.VIDEO_SETTINGS.videoId+'" class="btn btn-danger btn-sm">YouTube\'da Aç</a></div>';
            }
        }
      }
    });
  }

  // 3. API yükleme sinyalleri
  function onYouTubeIframeAPIReady() {
    setupYoutubePlayer();
  }

  // Sayfa değişimlerinde API zaten yüklüyse tetikle
  if (window.YT && window.YT.loaded) {
    setupYoutubePlayer();
  } else {
    if (!document.getElementById('yt-api-script')) {
      var tag = document.createElement('script');
      tag.id = 'yt-api-script';
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
  }
</script>

<script src="{% static 'js/video_tracker.js' %}"></script>
{% endif %}
{% endblock %}